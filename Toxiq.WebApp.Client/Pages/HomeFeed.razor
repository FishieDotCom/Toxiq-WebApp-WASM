@page "/"
@using Toxiq.Mobile.Dto
@using Toxiq.WebApp.Client.Components
@using Toxiq.WebApp.Client.Components.Core
@using Toxiq.WebApp.Client.Components.Feed
@using Toxiq.WebApp.Client.Services.Feed
@using Toxiq.WebApp.Client.Services.Authentication
@inherits ComponentBase
@implements IDisposable
@inject IFeedService FeedService
@inject IAuthenticationService AuthService
@inject NavigationManager Navigation

<PageTitle>Toxiq - Home</PageTitle>
<TopNavBar ShowBackButton="false">
    <MiddleContent>
        <div class="logo-container">
            <Logo />
        </div>
    </MiddleContent>
</TopNavBar>

<div class="home-feed-container centered-container">
    @if (isAuthenticated)
    {
        <!-- Feed Content using Fixed CollectionView -->
        <div class="feed-content">
            <CollectionView TItem="BasePost"
                            Items="@posts"
                            ItemTemplate="@PostItemTemplate"
                            OnLoadMore="@LoadMorePosts"
                            OnRefresh="@RefreshFeed"
                            HasMoreItems="@canLoadMore"
                            IsLoading="@isLoadingMore"
                            ItemHeight="@estimatedPostHeight"
                            BufferSize="3"
                            EmptyMessage="@GetEmptyMessage()"
                            CssClass="feed-collection" />
        </div>

        <!-- Floating Action Button -->
        <button class="floating-action-button" @onclick="GoToCreate">
            ➕
        </button>
    }
    else
    {
        <!-- Not authenticated state -->
        <div class="not-authenticated">
            <div class="welcome-content">
                <ToxiqLogo Height="64" />
                <h1 class="welcome-title">Welcome to Toxiq</h1>
                <p class="welcome-subtitle">Connect with your community</p>
                <PrimaryButton ButtonText="Sign In" OnClick="@GoToLogin" />
            </div>
        </div>
    }
</div>

@code {
    // State management
    private List<BasePost> posts = new();
    private GetPostDto searchQuery = new() { Page = 0, Count = 20 };
    private bool isLoadingMore = false;
    private bool canLoadMore = true;
    private bool isAuthenticated = false;
    private UserProfile? currentUser;
    private int estimatedPostHeight = 200;

    // Template for rendering each post
    private RenderFragment<BasePost> PostItemTemplate = (post) => __builder =>
    {
        <PostCard Post="@post" FullPost="false" />
    };

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to authentication state changes
        AuthService.AuthenticationStateChanged += OnAuthenticationStateChanged;

        // Check initial authentication state
        isAuthenticated = await AuthService.IsAuthenticatedAsync();

        if (isAuthenticated)
        {
            currentUser = await AuthService.GetCurrentUserAsync();
            await LoadInitialFeed();
        }
    }

    private async Task LoadInitialFeed()
    {
        try
        {
            searchQuery.Page = 0;
            var result = await FeedService.GetFeedAsync(searchQuery);
            posts = result.Data.ToList();
            canLoadMore = CanLoadMore(result);

            // Adjust estimated height based on actual posts
            if (posts.Any())
            {
                estimatedPostHeight = EstimatePostHeight(posts.First());
            }

            StateHasChanged(); // Ensure UI updates
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading initial feed: {ex.Message}");
        }
    }

    private async Task RefreshFeed()
    {
        try
        {
            searchQuery.Page = 0; // Reset to first page
            var result = await FeedService.RefreshFeedAsync(searchQuery);
            posts = result.Data.ToList();
            canLoadMore = CanLoadMore(result);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing feed: {ex.Message}");
        }
    }

    private async Task LoadMorePosts()
    {
        if (isLoadingMore || !canLoadMore)
        {
            Console.WriteLine($"LoadMorePosts blocked: isLoadingMore={isLoadingMore}, canLoadMore={canLoadMore}");
            return;
        }

        Console.WriteLine($"LoadMorePosts triggered: Current page={searchQuery.Page}, posts count={posts.Count}");

        isLoadingMore = true;
        StateHasChanged();

        try
        {
            // Increment page for next batch
            var result = await FeedService.LoadMorePostsAsync(searchQuery);

            Console.WriteLine($"LoadMorePosts result: {result.Data.Count} new posts loaded");

            // Add new posts to existing list
            posts.AddRange(result.Data);
            canLoadMore = CanLoadMore(result);

            Console.WriteLine($"LoadMorePosts complete: Total posts={posts.Count}, canLoadMore={canLoadMore}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading more posts: {ex.Message}");
        }
        finally
        {
            isLoadingMore = false;
            StateHasChanged();
        }
    }

    private void GoToCreate()
    {
        Navigation.NavigateTo("/create-post");
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }

    private bool CanLoadMore(SearchResultDto<BasePost> result)
    {
        // Can load more if we got the full requested amount
        var canLoad = result.Data.Count == searchQuery.Count;
        Console.WriteLine($"CanLoadMore: {canLoad} (got {result.Data.Count}, requested {searchQuery.Count})");
        return canLoad;
    }

    private string GetEmptyMessage()
    {
        return isAuthenticated ?
            "No posts in your feed yet. Follow some users to see their posts!" :
            "Sign in to see your personalized feed";
    }

    private int EstimatePostHeight(BasePost post)
    {
        // Estimate height based on post content
        var baseHeight = 120; // Header + actions
        var textLines = (post.Content?.Length ?? 0) / 50; // Rough estimate
        var textHeight = Math.Max(1, textLines) * 20;
        var mediaHeight = post.PostMedia?.Any() == true ? 200 : 0;
        var replyHeight = post.ReplyType != ReplyType.Non ? 100 : 0;

        return baseHeight + textHeight + mediaHeight + replyHeight;
    }

    private void OnAuthenticationStateChanged(object sender, AuthenticationStateChangedEventArgs e)
    {
        isAuthenticated = e.IsAuthenticated;
        currentUser = e.User;

        if (isAuthenticated && !posts.Any())
        {
            InvokeAsync(LoadInitialFeed);
        }
        else if (!isAuthenticated)
        {
            posts.Clear();
        }

        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthService.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}